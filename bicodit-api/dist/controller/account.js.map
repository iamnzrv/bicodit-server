{"version":3,"sources":["../../src/controller/account.js"],"names":["config","db","api","post","req","res","next","UserDataExt","findUserByEmail","body","email","err","userData","status","send","findUserByLogin","login","user","Account","register","username","password","account","passport","authenticate","session","newUser","User","_id","avatar","name","about","save","id","generateAccessToken","respondWithData","scope","failWithError","get","logout","findUserByToken","headers","token"],"mappings":"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","sourcesContent":["import e, { Router } from 'express';\nimport passport from 'passport';\nimport Account from '../models/account';\nimport User from '../models/user';\nimport UserDataExt from './extensions/user_data_ext';\n\nimport { generateAccessToken, respond, respondWithData, authenticate } from '../middleware/auth_middleware';\n\nexport default ({ config, db }) => {\n  let api = Router();\n\n  // '/bicoditapi/account/register'\n  api.post('/register', (req, res, next) => {\n    UserDataExt.findUserByEmail(req.body.email, (err, userData) => {\n      if (err) {\n        res.status(400).send();\n      } else if (userData) {\n        res.status(403).send();\n      } else {\n        UserDataExt.findUserByLogin(req.body.login, (err, user) => {\n          if (err) {\n            res.status(400).send();\n          } else if (user) {\n            res.status(403).send();\n          } else {\n            Account.register(new Account({ username: req.body.login, email: req.body.email }), req.body.password, function(err, account) {\n              if (err) {\n                res.status(400).send();\n              }\n              passport.authenticate('local', { session: false })(req, res, () => {\n                const newUser = new User({ account: req.user._id, avatar: \"rabbodefault\", name: \"\", about: \"\" })\n                newUser.save(err => {\n                  if (err) {\n                    res.status(400).send();\n                  }\n                  else {\n                    req.id = newUser.id;\n                    req.name = newUser.name;\n                    req.about = newUser.about;\n                    req.email = account.email;\n                    req.login = account.username;\n                    next()\n                  }\n                })\n              });\n            });\n          }\n        })\n      }\n    });\n  }, generateAccessToken, respondWithData);\n\n  // '/bicoditapi/account/login'\n  api.post('/login', (req, res, next) => {\n\t\tUserDataExt.findUserByLogin(req.body.login, (err, user) => {\n      if (err) {\n        res.status(400).send();\n      } else if (user == null) {\n        res.status(404).send();\n      } else {\n        req.id = user.id;\n        req.avatar = user.avatar;\n        req.name = user.name;\n        req.about = user.about;\n        req.email = user.email;\n        req.login = user.username;\n        next()\n\t\t\t}\n    });\n  }, passport.authenticate('local', { session: false, scope: [], failWithError: true }), (err, req, res, next) => {\n    if (err) {\n      res.status(403).send();\n    }\n  }, generateAccessToken, respondWithData);\n\n  // '/bicoditapi/account/logout'\n  api.get('/logout', authenticate, (req, res) => {\n    res.logout();\n    res.status(200).send('Successfully logged out');\n  });\n\n  // '/bicoditapi/account/me'\n  api.get('/me', (req, res, next) => {\n    UserDataExt.findUserByToken(req.headers.token, (err, user) => {\n      if (err) {\n        res.status(400).send();\n      } else if (user == null) {\n        res.status(404).send();\n      } else {\n        req.id = user.id;\n        req.avatar = user.avatar;\n        req.name = user.name;\n        req.about = user.about;\n        req.email = user.email;\n        req.login = user.username;\n        next()\n      }\n    })\n  }, respondWithData);\n\n  return api;\n}\n"],"file":"account.js"}